page: diff_117
    module: perl

    my ($file, $n_cluster, $n_output) = @ARGV
    $if !-f $file or !$n_cluster or !$n_output
        die "Usage: $0 $file n_cluster n_output\n"

    my @data_out
    push @data_out, get_diff($n_output)

    $print Loading $file ...
    my $flag
    &call open_r, $file
        $if /^Energy avg-0/
            $flag = 1
        $elif $flag
            my @tlist = split /\s+/, $_
            push @data_out, get_diff(\@tlist, $n_cluster, $n_output)

    &call open_W, diff-out.txt
        $foreach $l in @data_out
            print Out join(' ', @$l). "\n"


fncode: get_diff($l, $n_cluster, $n_output)
    # 26 ground state into 3 group of 9
    my @ground
    $for $i=1:27
        my $j = ($i) % 9 # use the fact that 27 is multiple of 9 and i=27 -> j=0
        $if $i+18>=26
            $ground[$j] = ($l->[$i] + $l->[$i+9] + $l->[$i+18]) / 3
        $else
            $ground[$j] = ($l->[$i] + $l->[$i+9]) / 2

    my $n = @$l
    # calc diff
    $for $i=27:$n
        my $j = ($i) % 9
        $l->[$i] -= $ground[$j]

    # cluster it
    my @l_out
    my $i = 27
    $for $i_out=0:$n_output
        my $sum
        $for $i_c=0:$n_cluster
            $sum += $l->[$i]
            $i++
        push @l_out, $sum/$n_cluster
    return [$l->[0], @l_out]

fncode: get_header($n_output)
    my @tlist = "Energy"
    $for $i=0:$n_output
        push @tlist, " out-$i"
    return  \@tlist
