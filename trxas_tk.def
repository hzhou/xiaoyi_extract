include: macros/tk_gui.def
page: tk_extract
    module: python
    title: XTA MXP data process (TRR Group)

    &call tk_main, 800x600
        $call content

subcode: input_trigger
    &call col, width=30
        G.lbl_trigger = tk.Label($(frm), text="Trigger")
        G.entry_trigger = tk.Entry($(frm), width=10)
        G.lbl_trigger.pack()
        G.entry_trigger.pack()

subcode: content
    $(if:0)
        G.title = tk.Label(text="$(title)")
        G.title.pack()

    $call vskip, 20
    &call row
        $call input_file, file_in, Check Data File
        $call input_folder, folder_in, Select Input Folder
        $call input_entry, folder_out, Select Output Folder
    &call row
        $call input_entry, trigger, Trigger\n(#th bunch)
        $call input_entry, range, File index range\n(min - max)
        $call input_select, gs_method, Ground State Method\n, 'per bunch GS', 'avg bunch GS'
    &call row
        $call input_entry, pre_n_avg, Number of orbitals\nfor GS
        $call input_entry, aft_n_avg, Number of orbitals\nfor spectrum
        $call input_entry, aft_npnt, Number of output\n TR spectra

    $list command_run
    &call row
        $call pack, btn, Button, text="Run", command=command_run

    $call init_default

subcode: _autoload
    $import * from trxas_extract

subcode: init_default
    $call set_entry, G.entry_folder_out, "../extract"

fncode: command_run
    $(for:trigger, range, gs_method, pre_n_avg, aft_n_avg, aft_npnt, folder_out)
        G.$1 = G.entry_$1.get()
    $if RE.match(r'(\d+)-(\d+)', G.range)
        G.idx_min = int(RE.m.group(1))
        G.idx_max = int(RE.m.group(2))
    # $call on_trigger
    idx = G.idx_min
    $while idx <= G.idx_max
        file_in = "%s/%s_%5d" % (G.folder_in, G.name, idx)
        $if G.folder_out.startswith('/')
            file_out = "%s/%s_%5d" % (G.folder_out, G.name, idx)
        $else
            file_out = "%s/%s/%s_%5d" % (G.folder_in, G.folder_out, G.name, idx)
        trxas = Extract()
        trxas.read(file_in)
        $if True
            trxas.process_avgbunch(file_out, int(G.trigger), int(G.pre_n_avg), int(G.aft_n_avg), int(G.aft_npnt))
        $else
            trxas.process_perbunch(file_out, int(G.trigger), int(G.pre_n_avg), int(G.aft_n_avg), int(G.aft_npnt))
    
fncode: check_folder(folder)
    $import listdir from os
    G.name = None
    G.idx_min = '99999'
    G.idx_max = '00000'
    $for f in listdir(folder)
        filepath = folder + '/' + f
        $if not G.name and Extract.is_sample_data(filepath)
            $if not G.file_in
                G.file_in = filepath
            $if RE.match(r'(.*)-\d+$', f)
                G.name = RE.m.group(1)
        $if G.name and RE.match(r'(.*)-(\d+)$', f)
            $if int(G.idx_min) > int(RE.m.group(2))
                G.idx_min = RE.m.group(2)
            $if int(G.idx_max) < int(RE.m.group(2))
                G.idx_max = RE.m.group(2)
    $if G.name
        $call set_entry, G.entry_range, "%s-%s" % (G.idx_min, G.idx_max)

    G.lbl_folder_in.config(text=shortname(folder))
    G.btn_folder_in.config(text = "Change Input Folder")

fncode: check_file(file)
    G.lbl_file_in.config(text=shortname(file))
    trxas = Extract()
    trxas.read(file)
    msg = "%d channels, %d orbitals, %d bunches, %d rows" % (trxas.c_max-trxas.c_min+1, trxas.o_max-trxas.o_min+1, trxas.b_max-trxas.b_min+1, trxas.num_rows)
    G.lbl_file_in_info.config(text=msg)

subcode: on_file_in    
    $if RE.match(r'(.*)/', G.file_in)
        G.folder_in = RE.m.group(1)
    check_file(G.file_in)
    $if G.folder_in
        check_folder(G.folder_in)

subcode: on_folder_in
    check_folder(G.folder_in)
    $if G.name
        check_file(G.file_in)

subcode: on_folder_out
    G.lbl_folder_out.config(text=shortname(G.folder_out))
    G.btn_folder_out.config(text = "Change Output Folder")

subcode: on_trigger
    msgbox.showinfo(message = "trigger: %s" % G.trigger)

fncode: shortname(str)
    $if len(str) > 20
        return "..." + str[-20:]
    $else
        return str

